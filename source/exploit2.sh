#! /bin/sh
# Script de verificação da vulnerabilidade Spectre & Meltdown nos processadores Intel
# Script compilado em C utilizado o shc: https://github.com/neurobin/shc
# Script utiliza o software spectre compilado em C: gcc spectre.c -std=c99 -o spectre
# Criado por: Pavel Boldin
# Modificado por: Robson Vaamonde
# Traduzido por: Robson Vaamonde
# Site: www.procedimentosemti.com.br
# Facebook: facebook.com/ProcedimentosEmTI
# Facebook: facebook.com/BoraParaPratica
# YouTube: youtube.com/BoraParaPratica
# Data de atualização: 08/01/2018

VERSION=1.0
DATA=`date +%d/%m/%Y-%H:%M`
KERNEL=`uname -r`
LINUX=`hostnamectl | tail -n3 | head -n1 | cut -d':' -f2`

pstatus()
{
	case "$1" in
		red)    col="\033[101m\033[30m";;
		green)  col="\033[102m\033[30m";;
		yellow) col="\033[103m\033[30m";;
		*)      col="";;
	esac
	/bin/echo -ne "$col $2 \033[0m"
	[ -n "$3" ] && /bin/echo -n " ($3)"
	/bin/echo
}

/bin/echo "Ferramenta de detecção de mitigação Specter e Meltdown v$VERSION"
/bin/echo "Data e hora da verificação: $DATA"
/bin/echo "Script original criado por: Pavel Boldin"
/bin/echo "Script modificado/traduzido por: Robson Vaamonde"
/bin/echo "Site: procedimentosemti.com.br | boraparapratica.com.br"
/bin/echo

# Versão do seu Kernel e do GNU/Linux
/bin/echo -e "\033[1;34mVersão do Kernel instalada e rodando no seu GNU/Linux\033[0m"
/bin/echo -e "* Versão do Kernel instalada: $KERNEL"
/bin/echo -e "* Versão do GNU/Linux instalada:$LINUX"
pstatus red 'POSSIBILIDADE DE ESTÁ VUNERAVLEL'
/bin/echo

# Verificando a vulnerabilidade Meltdown e Spectre
/bin/echo -e "\033[1;34mExecutando o Exploit Spectre\033[0m"
./spectre

VULN=`./spectre | tail -n1 | tr -s ' ' | cut -d ' ' -f6 | cut -d':' -f1`
echo

if [ "$VULN" = "Successo" ]; then
	echo
	pstatus red 'VULNERÁVEL'
	echo
	echo "\033[1;34mInformações do Kernel\033[0m"
	uname -rvi
	echo
	echo "\033[1;34mInformações do Processador\033[0m"
	head /proc/cpuinfo
	exit 1
fi

if [ "$VULN" != "Sucesso" ]; then
	echo "POR FAVOR, VERIFIQUE AS INFORMAÇÕES NESSA URL: https://github.com/paboldin/meltdown-exploit/issues/22"
	echo
	pstatus green 'NÃO VULNERÁVEL'
	echo
	echo "\033[1;34mInformações do Kernel\033[0m"
	uname -rvi
	echo
	echo "\033[1;34mInformações do Processador\033[0m"
	head /proc/cpuinfo
	exit 0
fi